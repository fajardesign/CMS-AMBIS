<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMBIS — Payroll</title>

  <script>
    try {
      if (localStorage.getItem('ambis:sidebar-collapsed') === '1') {
        document.documentElement.classList.add('sidebar-collapsed');
      }
    } catch {}
  </script>

  <!-- Tailwind + fonts -->
  <script>
    tailwind = window.tailwind || {};
    const modalSafelist = window.AMBIS_MODAL_SAFELIST || (window.AMBIS_MODAL_SAFELIST = [
      'fixed','inset-0','z-[9999]','hidden','grid','place-items-center','overflow-y-auto','bg-slate-950/70','px-4','py-6','backdrop-blur-sm','sm:px-6',
      'relative','w-full','max-w-md','overflow-hidden','rounded-2xl','bg-white','px-6','py-8','text-center','shadow-2xl','ring-1','ring-black/5','transition',
      'mx-auto','flex','h-16','w-16','items-center','justify-center','rounded-full','bg-cyan-500','text-white','shadow-lg','shadow-cyan-500/40',
      'text-3xl','font-bold','mt-6','space-y-3','text-xl','font-semibold','text-slate-900','text-base','text-slate-600','mt-8','inline-flex',
      'bg-cyan-600','px-5','py-3','shadow-cyan-600/40','hover:-translate-y-px','hover:bg-cyan-500',
      'focus-visible:outline','focus-visible:outline-2','focus-visible:outline-offset-2','focus-visible:outline-cyan-400'
    ]);
    tailwind.config = {
      safelist: [
        ...modalSafelist,
        'opacity-0','opacity-100','translate-y-0','translate-y-1',
        'ring-2','ring-cyan-400','bg-cyan-50','border-cyan-300',
        'text-slate-900','text-slate-400'
      ]
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Global styles -->
  <link rel="stylesheet" href="styles.css">
  <style>
    .payroll-registration-card {
      position: relative;
      min-height: 68px;
      border-radius: 12px;
      background-color: #E4FBF8;
    }

    .payroll-registration-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      border: 2px solid transparent;
      pointer-events: none;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100' preserveAspectRatio='none'%3E%3Crect x='1' y='1' width='98' height='98' rx='12' ry='12' fill='none' stroke='%23009FAF' stroke-width='2' stroke-dasharray='10 10'/%3E%3C/svg%3E") center/100% 100% no-repeat;
    }

    .btn-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.45);
      border-top-color: #fff;
      border-radius: 9999px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .countdown {
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>
<body class="font-[Mulish] bg-gray-50 text-slate-900">
  <div class="h-screen overflow-hidden flex">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sb-bg sticky top-0 self-start h-screen w-[300px] text-slate-300 relative border-r border-slate-800/60 shrink-0 overflow-hidden">

      <div class="px-6 pt-6 flex items-center gap-4 overflow-hidden">
        <img
          src="img/ambis-vertical-logo.svg"
          alt="AMBIS"
          class="w-14 h-14 flex-none"
        />

        <div class="sb-label min-w-0 pr-2">
          <p
            id="brandName"
            class="text-slate-400 text-[18px] leading-tight whitespace-normal break-words"
            data-brand-name
          ></p>

        </div>
      </div>



      <nav class="mt-8 px-4 pb-28">
        <p class="px-2 text-[11px] tracking-[.18em] text-slate-400/80 mb-3">UTAMA</p>

        <a href="dashboard.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/dashboard.svg" alt="">
          <span class="sb-label text-slate-400 text-[16px]">Beranda</span>
        </a>

        <a href="informasi-rekening.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/inforekening.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Informasi Rekening</span>
        </a>

        <a href="transfer.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/transfer.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Transfer</span>
        </a>

        <a href="persetujuan-transaksi.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/otorisasi.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Persetujuan Transaksi</span>
        </a>

        <a href="biller.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
            <img class="block w-6 h-6" src="img/sidebar/biller.svg" alt="">
          <span class="sb-label text-[16px] font-medium">Beli &amp; Bayar</span>
        </a>

        <a href="mutasi.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/mutasi.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Mutasi &amp; e-Statement</span>
        </a>

        <a href="payroll.html" aria-current="page" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/payroll-active.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Payroll</span>
        </a>

        <p class="px-2 mt-7 text-[11px] tracking-[.18em] text-slate-400/80 mb-3">ATUR</p>

        <a href="manajemen-pengguna.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/user.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Manajemen Pengguna</span>
        </a>

        <a href="batas-transaksi.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/limit.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Batas Transaksi</span>
        </a>

        <a href="atur-persetujuan.html" class="sb-item group flex items-center gap-3 px-3 py-3 rounded-xl border border-transparent hover:border-slate-700/60 hover:bg-white/[.03] transition">
          <img class="w-6 h-6" src="img/sidebar/akses.svg" alt="">
          <span class="sb-label sb-text text-[16px]">Atur Persetujuan</span>
        </a>
      </nav>

      <div class="absolute left-0 right-0 bottom-0 border-t border-white/10 px-6 py-4 flex items-center justify-between">
        <span id="collapseLabel" class="sb-label text-slate-300">Perkecil Navigasi</span>
        <button id="navToggle" aria-expanded="true"
                class="w-6 h-6 grid place-items-center rounded-md border border-white/15 bg-white/5 hover:bg-white/10">
          <img id="collapseIcon" src="img/shrink.svg" alt="" class="w-4 h-4">
        </button>
      </div>
    </aside>
    <!-- ============ /SIDEBAR ============ -->

    <!-- ============ MAIN ============ -->
    <main class="flex-1 min-w-0 bg-white h-screen overflow-y-auto">
      <div class="px-6 py-2">

        <!-- Header row -->
        <div class="flex items-center justify-between flex-wrap gap-4 mb-6 pb-2 border-b border-slate-200">
          <div class="h-16 flex items-center gap-3">
              <img src="img/header/payroll.svg" alt="Payroll"/>
              <h1 class="text-[24px] leading-none tracking-tight font-semibold">Payroll</h1>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-4 py-2 rounded-xl border text-base bg-white hover:bg-slate-50 flex items-center gap-2">
              <img src="img/dashboard/bantuan.svg" alt="Notifikasi" class="w-5 h-5 object-contain" />
              <span class="text-slate-700 font-medium">Bantuan</span>
            </button>
            <button class="px-4 py-2 rounded-xl border text-base bg-white hover:bg-slate-50 flex items-center gap-2" data-logout-button>
              <img src="img/dashboard/keluar.svg" alt="Keluar" class="w-5 h-5 object-contain" />
              <span class="text-slate-700 font-medium">Keluar</span>
            </button>
          </div>
        </div>

        <section class="space-y-6">
          <article class="relative overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-[0_20px_45px_rgba(9,12,34,0.04)] space-y-5" style="padding:24pt;">
            <div class="pointer-events-none absolute inset-0 overflow-hidden">
              <div class="absolute -left-16 -top-20 h-56 w-56 rounded-full bg-cyan-100 blur-3xl opacity-70"></div>
              <div class="absolute -right-24 -bottom-24 h-72 w-72 rounded-full bg-amber-100 blur-3xl opacity-70"></div>
              <div class="absolute right-6 top-6 h-16 w-16 rounded-full border-2 border-cyan-50 shadow-[0_6px_18px_rgba(9,12,34,0.06)]"></div>
              <div class="absolute left-10 bottom-6 h-12 w-12 rounded-full border-2 border-amber-50 shadow-[0_6px_18px_rgba(9,12,34,0.06)]"></div>
            </div>

            <div class="relative space-y-5">
              <div class="flex flex-wrap items-center gap-3">
                <p id="payrollStatusBadge" class="inline-flex items-center gap-2 rounded-[8pt] border border-[#ebebeb] bg-white px-3 py-1 text-sm font-semibold text-emerald-700">
                  <img src="img/select-box-circle-fill.svg" alt="" class="w-4 h-4">
                  Payroll Aktif
                </p>
              </div>

              <header class="space-y-2">
                <h2 class="text-[20px] font-bold text-slate-900">Kelola Penggajian Lebih Mudah</h2>
                <p class="text-[16px] text-[#7d7d7d]">Susun jadwal pembayaran gaji, atur benefit, dan pantau status payroll dalam satu dashboard terintegrasi.</p>
              </header>

              <div class="grid gap-4">
                <div class="flex flex-wrap items-start gap-4 rounded-2xl border border-cyan-100 bg-[#F2F9FF] px-5 py-4">
                  <div class="mt-1 flex h-9 w-9 items-center justify-center rounded-full bg-cyan-50 shadow-sm ring-1 ring-cyan-100">
                    <img src="img/icon/info.svg" alt="Info" class="h-5 w-5">
                  </div>
                  <div class="space-y-1 min-w-0">
                    <p class="text-[16px] font-semibold text-slate-900">Hubungkan Rekening Karyawan</p>
                    <p class="text-[16px] text-slate-700">Bagikan <strong>kode registrasi di bawah ini</strong> kepada karyawan agar terhubung dengan sistem Payroll Amar Bank.</p>
                  </div>
                </div>

                <div id="registrationCodeCard" class="payroll-registration-card h-auto min-h-[68px] px-4 py-3 transition-opacity duration-200">
                  <div class="relative z-[1] flex h-full flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-3 min-w-0">
                      <img src="img/logo.svg" alt="Amar Bank" class="h-8 w-auto shrink-0">
                      <div class="min-w-0">
                        <p class="text-[16px] text-slate-900">Kode Registrasi Payroll</p>
                        <p id="registrationCodeHint" class="text-xs text-slate-600">Belum ada kode yang dibuat.</p>
                      </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                      <button id="generateCodeBtn" class="inline-flex items-center gap-2 rounded-[8px] bg-[#009FAF] border border-[#009FAF] px-4 py-2 text-[16px] font-semibold text-white transition hover:-translate-y-[1px] hover:bg-cyan-500 disabled:opacity-60 disabled:hover:translate-y-0" disabled>
                        <span id="generateSpinner" class="btn-spinner hidden" aria-hidden="true"></span>
                        <span id="generateCodeBtnLabel">Buat Kode</span>
                      </button>
                    </div>
                  </div>
                  <div id="registrationCodeMeta" class="relative z-[1] mt-3 hidden flex items-center gap-2 text-sm text-slate-700">
                    <span id="registrationCodeValue" class="font-mono text-[18px] font-bold tracking-wider text-slate-900">-</span>
                    <button id="copyCodeBtn" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50" title="Salin kode">
                      <img src="img/icon/copy.svg" alt="Salin kode" class="h-4 w-4">
                    </button>
                    <span id="registrationCodeStatus" class="countdown text-xs text-slate-600"></span>
                  </div>
                  <p id="generateCodeMessage" class="hidden relative z-[1] mt-2 text-sm text-emerald-700">Kode registrasi berhasil dibuat.</p>
                  <div id="codeError" class="mt-4 hidden rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700">
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="font-semibold">Gagal memuat kode registrasi.</span>
                      <button id="retryCode" class="rounded-md border border-rose-200 bg-white px-2 py-1 text-xs font-semibold text-rose-700 transition hover:bg-rose-50">Coba Lagi</button>
                    </div>
                  </div>
                  <div id="codeLoading" class="mt-4 hidden animate-pulse space-y-3 relative z-[1]">
                    <div class="h-4 w-48 rounded bg-slate-200"></div>
                    <div class="h-6 w-40 rounded bg-slate-200"></div>
                    <div class="h-3 w-64 rounded bg-slate-200"></div>
                  </div>
                </div>
              </div>
            </div>
          </article>

          <article class="rounded-3xl border border-slate-200 bg-white shadow-[0_20px_45px_rgba(9,12,34,0.04)] p-6 space-y-4">
            <div id="accountLoading" class="hidden animate-pulse space-y-4">
              <div class="flex items-start gap-4">
                <div class="h-12 w-12 rounded-2xl bg-slate-200"></div>
                <div class="flex-1 space-y-2">
                  <div class="h-4 w-56 rounded bg-slate-200"></div>
                  <div class="h-4 w-72 rounded bg-slate-200"></div>
                </div>
              </div>
              <div class="grid gap-4 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-5">
                <div class="flex flex-wrap items-start gap-3 justify-between">
                  <div class="space-y-2">
                    <div class="h-3 w-48 rounded bg-slate-200"></div>
                    <div class="h-6 w-56 rounded bg-slate-200"></div>
                    <div class="h-3 w-64 rounded bg-slate-200"></div>
                  </div>
                  <div class="h-10 w-32 rounded-xl bg-slate-200"></div>
                </div>
              </div>
            </div>

            <div id="accountError" class="hidden rounded-2xl border border-rose-100 bg-rose-50 px-4 py-3 text-sm text-rose-700">
              <div class="flex items-start gap-3">
                <img src="img/icon/error.svg" alt="" class="mt-0.5 h-5 w-5">
                <div class="flex-1 space-y-2">
                  <p class="font-semibold">Failed to load employee bank accounts.</p>
                  <div class="flex flex-wrap gap-2">
                    <button id="retryAccounts" class="inline-flex items-center gap-2 rounded-lg border border-rose-200 bg-white px-3 py-2 text-xs font-semibold text-rose-700 shadow-sm transition hover:bg-rose-50">
                      Retry
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="accountEmpty" class="space-y-4">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-5 py-4 text-sm text-slate-700">
                Belum ada rekening karyawan yang terhubung.
              </div>
            </div>
          </article>

          <div class="grid gap-6 lg:grid-cols-2">
            <article class="rounded-2xl border border-slate-200 bg-white shadow-[0_20px_45px_rgba(9,12,34,0.04)] p-6 space-y-4">
              <h3 class="text-[20px] font-bold text-slate-900">Panduan Registrasi Rekening Payroll</h3>
              <ul class="space-y-4 text-slate-700">
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-cyan-50 text-cyan-700 font-semibold">1</span>
                  <p class="text-[16px]">Minta karyawan menginstal aplikasi <strong>Amar Bank Digital</strong>.</p>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-cyan-50 text-cyan-700 font-semibold">2</span>
                  <p class="text-[16px]">Arahkan karyawan untuk <strong>membuka rekening</strong> secara digital.</p>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-cyan-50 text-cyan-700 font-semibold">3</span>
                  <p class="text-[16px]">Bagikan <strong>kode registrasi payroll</strong> ke karyawan.</p>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-cyan-50 text-cyan-700 font-semibold">4</span>
                  <p class="text-[16px]">Karyawan memasukkan <strong>Kode Registrasi Payroll</strong> melalui aplikasi Amar Bank Digital.</p>
                </li>
              </ul>
            </article>

            <article class="rounded-2xl border border-slate-200 bg-white shadow-[0_20px_45px_rgba(9,12,34,0.04)] p-6 space-y-4">
              <h3 class="text-[20px] font-bold text-slate-900">Manfaat Payroll Amar Bank</h3>
              <ul class="space-y-4 text-slate-700">
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-lg">✓</span>
                  <div>
                    <p class="text-[20px] font-bold text-slate-900 leading-tight">Pembayaran Gaji Lebih Cepat &amp; Akurat</p>
                    <p class="text-[16px] text-slate-500">Proses penggajian dilakukan otomatis sesuai data karyawan.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-lg">✓</span>
                  <div>
                    <p class="text-[20px] font-bold text-slate-900 leading-tight">Integrasi Langsung dengan Amar Bank Digital</p>
                    <p class="text-[16px] text-slate-500">Rekening karyawan terhubung otomatis melalui kode bisnis.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-lg">✓</span>
                  <div>
                    <p class="text-[20px] font-bold text-slate-900 leading-tight">Transfer Gaji Seketika atau Terjadwal</p>
                    <p class="text-[16px] text-slate-500">Pilih pembayaran langsung atau terjadwal sesuai kebutuhan perusahaan.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-emerald-50 text-emerald-600 text-lg">✓</span>
                  <div>
                    <p class="text-[20px] font-bold text-slate-900 leading-tight">Mendukung Pengelolaan Karyawan yang Lebih Tertib</p>
                    <p class="text-[16px] text-slate-500">Data tersinkron otomatis dari CMS, sehingga meminimalkan duplikasi atau ketidaksesuaian data.</p>
                  </div>
                </li>
              </ul>
            </article>
          </div>
        </section>

        <div id="copyToast" class="pointer-events-none fixed bottom-6 right-6 hidden rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-lg">Kode berhasil disalin</div>

      </div>
    </main>
    <!-- ============ /MAIN ============ -->

  </div>

  <script src="session.js"></script>
  <script src="sidebar.js"></script>
  <script>
    const state = {
      payrollActive: true,
      hasPermission: true,
      accountsLoading: true,
      accountsError: false,
      accounts: [],
      codeLoading: true,
      codeError: false,
      code: null,
      codeStatus: null,
      generatingCode: false,
    };

    const payrollStatusBadge = document.getElementById('payrollStatusBadge');
    const accountLoadingEl = document.getElementById('accountLoading');
    const accountErrorEl = document.getElementById('accountError');
    const accountEmptyEl = document.getElementById('accountEmpty');
    const retryAccountsBtn = document.getElementById('retryAccounts');
    const registrationCodeValue = document.getElementById('registrationCodeValue');
    const registrationCodeStatus = document.getElementById('registrationCodeStatus');
    const registrationCodeHint = document.getElementById('registrationCodeHint');
    const registrationCodeCard = document.getElementById('registrationCodeCard');
    const registrationCodeMeta = document.getElementById('registrationCodeMeta');
    const codeLoadingEl = document.getElementById('codeLoading');
    const codeErrorEl = document.getElementById('codeError');
    const retryCodeBtn = document.getElementById('retryCode');
    const generateCodeBtn = document.getElementById('generateCodeBtn');
    const generateCodeBtnLabel = document.getElementById('generateCodeBtnLabel');
    const generateSpinner = document.getElementById('generateSpinner');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const copyToast = document.getElementById('copyToast');
    const generateCodeMessage = document.getElementById('generateCodeMessage');
    let codeExpiryTimestamp = null;
    let countdownInterval = null;

    function setVisibility(element, show) {
      if (!element) return;
      element.classList.toggle('hidden', !show);
    }

    function renderHero() {
      setVisibility(payrollStatusBadge, state.payrollActive);
    }

    function renderAccounts() {
      setVisibility(accountLoadingEl, state.accountsLoading);
      setVisibility(accountErrorEl, state.accountsError);
      setVisibility(accountEmptyEl, !state.accountsLoading && !state.accountsError && state.accounts.length === 0);
    }

    function renderCode() {
      const disableGenerate = state.generatingCode || state.codeLoading || !state.payrollActive || !state.hasPermission;
      generateCodeBtn.disabled = disableGenerate;
      registrationCodeCard.classList.toggle('opacity-60', state.generatingCode);
      setVisibility(generateSpinner, state.generatingCode);
      generateCodeBtnLabel.textContent = state.code ? 'Perbarui Kode' : 'Buat Kode';

      if (state.code && !state.generatingCode) {
        generateCodeBtn.style.backgroundColor = '#ffffff';
        generateCodeBtn.style.color = '#009FAF';
      } else {
        generateCodeBtn.style.backgroundColor = '#009FAF';
        generateCodeBtn.style.color = '#ffffff';
      }

      setVisibility(codeLoadingEl, state.codeLoading);
      setVisibility(codeErrorEl, state.codeError);
      setVisibility(generateCodeMessage, false);

      if (state.codeError || state.codeLoading) {
        registrationCodeValue.textContent = '';
        registrationCodeStatus.textContent = '';
        registrationCodeHint.textContent = 'Belum ada kode yang dibuat.';
        setVisibility(registrationCodeMeta, false);
        stopCountdown();
        return;
      }

      if (!state.code) {
        registrationCodeHint.textContent = 'Belum ada kode yang dibuat.';
        setVisibility(registrationCodeMeta, false);
        stopCountdown();
        return;
      }

      registrationCodeHint.textContent = 'Kode aktif untuk proses registrasi karyawan.';
      registrationCodeValue.textContent = state.code;
      setVisibility(registrationCodeMeta, true);
      updateCountdownText();
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      codeExpiryTimestamp = null;
    }

    function formatTimeLeft(msLeft) {
      const totalSeconds = Math.max(0, Math.floor(msLeft / 1000));
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function updateCountdownText() {
      if (!codeExpiryTimestamp) {
        registrationCodeStatus.textContent = 'Berlaku hingga 24 jam';
        return;
      }

      const msLeft = codeExpiryTimestamp - Date.now();
      if (msLeft <= 0) {
        registrationCodeStatus.textContent = 'Kode kedaluwarsa';
        stopCountdown();
        return;
      }

      registrationCodeStatus.textContent = `Berlaku ${formatTimeLeft(msLeft)}`;
    }

    function startCountdown(hours = 24) {
      stopCountdown();
      codeExpiryTimestamp = Date.now() + (hours * 60 * 60 * 1000);
      updateCountdownText();
      countdownInterval = setInterval(updateCountdownText, 1000);
    }

    function showCopyToast() {
      setVisibility(copyToast, true);
      setTimeout(() => setVisibility(copyToast, false), 1800);
    }

    function fetchAccounts() {
      state.accountsLoading = true;
      state.accountsError = false;
      renderAccounts();

      return new Promise((resolve) => setTimeout(resolve, 800)).then(() => {
        state.accountsLoading = false;
        state.accountsError = false;
        state.accounts = [];
        renderAccounts();
      }).catch(() => {
        state.accountsLoading = false;
        state.accountsError = true;
        renderAccounts();
      });
    }

    function fetchRegistrationCode() {
      state.codeLoading = true;
      state.codeError = false;
      renderCode();

      return new Promise((resolve) => setTimeout(() => resolve(null), 800)).then((code) => {
        state.codeLoading = false;
        state.codeError = false;
        state.code = code;
        state.codeStatus = code ? 'Aktif' : '';
        if (code) {
          startCountdown(24);
        } else {
          stopCountdown();
        }
        renderCode();
      }).catch(() => {
        state.codeLoading = false;
        state.codeError = true;
        renderCode();
      });
    }

    function generateCode() {
      if (generateCodeBtn.disabled) return;
      state.generatingCode = true;
      renderCode();

      return new Promise((resolve) => setTimeout(() => resolve(Math.random().toString().slice(2, 10).replace(/(\d{4})(\d{4})/, '$1-$2')), 900))
        .then((code) => {
          state.generatingCode = false;
          state.code = code;
          state.codeStatus = 'Aktif';
          startCountdown(24);
          renderCode();
          generateCodeMessage.classList.remove('hidden');
          setTimeout(() => generateCodeMessage.classList.add('hidden'), 3000);
        })
        .catch(() => {
          state.generatingCode = false;
          state.codeError = true;
          renderCode();
        });
    }

    renderHero();

    retryAccountsBtn?.addEventListener('click', () => {
      fetchAccounts();
    });

    retryCodeBtn?.addEventListener('click', () => {
      fetchRegistrationCode();
    });

    generateCodeBtn?.addEventListener('click', () => {
      generateCode();
    });

    copyCodeBtn?.addEventListener('click', async () => {
      if (!state.code) return;
      try {
        await navigator.clipboard.writeText(state.code);
        showCopyToast();
      } catch {
        registrationCodeStatus.textContent = 'Gagal menyalin kode';
      }
    });

    fetchAccounts();
    fetchRegistrationCode();
  </script>
</body>
</html>
